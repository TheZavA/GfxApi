#version 400

in vec3 pos;
in vec4 world_pos;
in float ao;
in float gao;
in vec3 normal;

uniform float res;

uniform vec3 cameraPos;

out vec4 frag_colour;

vec3 applyFog( in vec3  rgb,       // original color of the pixel
               in float distance,
			   in vec3  rayDir ) // camera to point distance
{
    float b =  0.0002;
    //float fogAmount = 1.0 - exp( -distance*b );
	float fogAmount = 6.1 * exp(-cameraPos.y*b) * (1.0-exp( -distance*rayDir.y*b ))/rayDir.y;
    vec3  fogColor  = vec3(0.5,0.6,0.8);
    return mix( rgb, fogColor, fogAmount );
}

vec3 applyFog2( in vec3  rgb,     // original color of the pixel
               in float distance, // camera to point distance
               in vec3  rayDir)   // camera to point vector
{
	float b =  0.000005;
    float fogAmount = 1.0 - exp( -distance*b );
	//float fogAmount = 0.8 * exp(-cameraPos.y*b) * (1.0-exp( -distance*rayDir.y*b ))/rayDir.y;
    float sunAmount = max( dot( rayDir, vec3(0.6, 0.4, 0.2) ), 0.0 );
    vec3  fogColor  = mix( vec3(0.5,0.6,0.9), // bluish
                           vec3(1.0,0.9,0.7), // yellowish
                           pow(sunAmount,8.0) );
    return mix( rgb, fogColor, fogAmount );
}

vec3 applyFog3( in vec3  rgb,     // original color of the pixel
               in float distance, // camera to point distance
               in vec3  rayDir)   // camera to point vector
{
   float maxFogHeight = 900; // higher the fog won't go
   float c = 0.002;
   float b = 0.2;

   float posy = -world_pos.y;

   float dist = distance;
 
   // if this is not done, the result will look awful
//   if(  pos.y > maxFogHeight)
//   {		
//       return vec3(0.5,0.6,0.9);
//   }
 
   // distance in fog is calculated with a simple intercept theorem
   float distInFog = dist * (maxFogHeight - posy) / ( posy - cameraPos.y);
 
   // when dist is 0, log(dist) is 1, so subtract this
   float fogAmount = (log(distInFog * c) - 1) * b;
 
   // at the top border, the value can get greater than 1, so clamp
   fogAmount = clamp(fogAmount, 0, 1);
 
   // final mix of colors
   return mix(rgb, vec3(0.5,0.6,0.9), fogAmount);
}

void main () 
{
   vec3 dFdxPos = dFdx( world_pos.rgb );
	vec3 dFdyPos = dFdy( world_pos.rgb );
	vec3 facenormal = normalize( cross(dFdxPos,dFdyPos ));

   vec3 n1 = normalize(vec3(facenormal.x, facenormal.y, facenormal.z));
   float intensity = clamp( dot( n1, vec3(0.4, 0.8, 0.2)), 0, 1 );
   //frag_colour = vec4(0.8,0.8,0.8,0) * (intensity * 2);
   //frag_colour = vec4(ao,ao,ao,0);
   frag_colour = (vec4(0.8,0.8,0.8,0) * (intensity) + vec4(0.4,0.4,0.4,0) ) * ao * gao;

   //vec3 color =  applyFog3( vec3(frag_colour.rgb ) ,
	//					distance(cameraPos, world_pos.xyz),
	//					normalize(cameraPos - world_pos.xyz));

   vec3 color =  applyFog2( vec3(frag_colour.rgb ) ,
							 distance(cameraPos, world_pos.xyz),
							 normalize(cameraPos - world_pos.xyz));

   frag_colour = vec4(vec3(color.rgb), 1);
   return;
	
	
    

	
   /* vec4 rock_normal = mapZoom(tex3) ;
    vec4 grass_normal = mapZoom(tex4) ;

    float intensity_rock = dot(vec3(0.9, 0.6, 0.2), vec3(rock_normal.x, -rock_normal.y, rock_normal.z)) ;
    float intensity_grass = dot(vec3(0.9, 0.6, 0.2), vec3(grass_normal.x, -grass_normal.y, grass_normal.z)) ;

    vec4 rock_color = mapZoom(tex1) * intensity_rock * 2;

	vec4 grass_color = mapZoom(tex2) * intensity_grass * 2;


	float slope = 1.0f - (-normal.y) ;
	vec4 normal_color = rock_color * 1.1;

	vec4 textureColor;
	float blendAmount = 0;

	//normal_color = vec4(0,0.6,0.1,0) * 1.1;
	if(slope < 0.1f)
    {
          blendAmount = slope / 0.1f;
          textureColor = mix(grass_color, normal_color, blendAmount);
    }
	

    if((slope < 0.3f) && (slope >= 0.1f))
    {
        blendAmount = (slope - 0.1f) * (1.0f / (0.3f - 0.1f));
		
        textureColor = mix(normal_color, rock_color, blendAmount);
    }

    if(slope >= 0.3f) 
    {
        textureColor = rock_color;
    }



    vec3 MaterialAmbientColor = vec3(0.05, 0.05, 0.05) * textureColor.rgb;
	//MaterialAmbientColor = vec3(0.7, 0.7, 0.7);

	vec3 color =  applyFog3( vec3(MaterialAmbientColor.rgb + textureColor.rgb * intensity) ,
							 distance(cameraPos, world_pos.xyz),
							 normalize(cameraPos - world_pos.xyz));

   color =  applyFog2( color ,
							 distance(cameraPos, world_pos.xyz),
							 normalize(cameraPos - world_pos.xyz));

	frag_colour = vec4(color.x, color.y, color.z, 1) ;
	//vec3 colour =  vec3(MaterialAmbientColor.rgb + textureColor.rgb * intensity);

//	frag_colour = vec4(0, 0, 0, 1) ;


	//material.x = 1;
	//if(int(material) == 1)
	{
	//	frag_colour = vec4(grass_color.xyz, 1)* intensity;
	}
	//else if (int(material) == 2)
	{
		//frag_colour = vec4(rock_color.xyz, 1)* intensity;
	}
//	else if (int(material) == 3)
	{
	//	frag_colour = vec4(vec3(MaterialAmbientColor.rgb + textureColor.rgb * intensity), 1);
		//frag_colour = vec4(rock_color.xyz, 1) * 0.8f * intensity;
	}



    frag_colour = vec4(vec3(MaterialAmbientColor.rgb + textureColor.rgb * intensity), 1);
	//frag_colour = vec4(vec3(MaterialAmbientColor.rgb  * intensity), 1);
 */   
}